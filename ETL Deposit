WITH A AS (
SELECT 
    SYM_RUN_DATE, CN, LOAI_KHACHHANG, 
    CASE 
        WHEN LOAI_TIEN <> 'VND' THEN 'KHAC' 
        ELSE LOAI_TIEN END AS LOAI_TIEN, 
    CASE 
        WHEN LOAI_KYHAN <> 'KKH' THEN 'CKH'
        ELSE LOAI_KYHAN END AS LOAI_KYHAN, 
    SODU_QD 
FROM kmdw.bcqt_huydong
WHERE SYM_RUN_DATE IN (
    SELECT MAX(SYM_RUN_DATE) FROM kmdw.bcqt_huydong
))
SELECT SYM_RUN_DATE, CN, LOAI_KHACHHANG, LOAI_KYHAN, LOAI_TIEN, SUM(SODU_QD) AS SODU_QD
FROM A
GROUP BY SYM_RUN_DATE, CN, LOAI_KHACHHANG, LOAI_KYHAN, LOAI_TIEN
