INSERT INTO CHOVAY_Df (REPORIING_DATE, BRANCH_ NO, BUSINESS_LINE, YEAR, MONTH, DUNO_QD, OUTS_PRINC_NV_TAR)
WITH A AS (
  SELECT SYM_RUN_DATE, MACN, BUSINESS_LINE, SUM(DUNO_QD) AS DUNO_QD
  FROM BCQT_CHOVAY
GROUP BY SYM_RUN_DATE, MACN, BUSINESS_LINE), 
B AS (
  SELECT 
    SYM_RUN_DATE, MACN AS BRANCH_NO, BUSINESS_LINE, DUNO_OD/1000000000 AS DUNO_QD, 
    EXTRACT (MONTH FROM SYM_RUN_DATE) AS MONTH, 
    EXTRACT (YEAR FROM SYM_RUN_DATE) AS YEAR
FROM A), 
C AS (
SELECT
  2023 AS YEAR, MONTH, BRANCH_NO, BUSINESS_LINE, TARGET 
FROM BCQT_KH_CHOVAY), 
D AS ( 
SELECT
  YEAR, MONTH, BRANCH_NO, BUSINESS_LINE, SUM(TARGET) AS TARGET
FROM C
GROUP BY YEAR, MONTH, BRANCH NO, BUSINESS _LINE)
SELECT
  B.SYM_RUN_DATE AS REPORTING_DATE,
  B.BRANCH_NO, B.BUSINESS_LINE, B.YEAR, B.MONTH,
  B.DUNO_QD, D.TARGET AS OUTS_PRINC_CNV_TAR 
FROM B 
LEFT JOIN D
ON B.YEAR = D.YEAR 
AND B.MONTH = D.MONTH
AND B.BRANCH_NO = D.BRANCH_NO
AND B.BUSINESS_LINE = D.BUSINESS_LINE;
